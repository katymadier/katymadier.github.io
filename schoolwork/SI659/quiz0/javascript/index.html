<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Quiz 0: JavaScript</title>
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

  <style>
    .none {
      filter: none;
    }

    .pink {
      filter: url(#pink);
    }

    .yellow {
      filter: url(#yellow);
    }

    body,
    html,
    #container {
      margin: 0;
      display: flex;
      width: 100%;
      height: 100%;
      touch-action: none overflow: hidden;
    }

    #canvas {
      top: 0;
      position: absolute;
      z-index: 0;
      overflow: hidden;
    }

    #video {
      top: 0;
      position: absolute;
      overflow: hidden;
      z-index: -1;
      touch-action: none;
      width: 100%;
      display:none;
    }

    #selected {
      bottom: 5px;
      right: 5px;
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: white;
    }
    #clicked {
      bottom: 5px;
      right: 60px;
      position: absolute;
      width: 50px;
      height: 50px;
      background-color: white;
    }
  </style>
</head>

<body>
  <!-- <svg width="0" height="0" xmlns="http://www.w3.org/2000/svg" version="1.1">
    <defs>
      <filter id="svgfilter" x="0%" y="0%" width="100%" height="100%">
        <filter id="pink">
          <feColorMatrix result="original" id="svgcolormatrix" type="matrix" values="0.6 1.7 1.7 0.2 -0.1 0.1 0.5 0 0 0 0.3 0 1 0 0 0 0 0 1 -0.04"></feColorMatrix>
        </filter>
        <filter id="yellow">
          <feColorMatrix result="original" id="svgcolormatrix" type="matrix" values="0.6 1.7 1.7 0.2 -0.1 0.1 0.5 0 0.6 -0.1 -1 0.8 1 0 0.6 1.1 0 -0.7 0.5 -0.2"></feColorMatrix>
        </filter>
      </filter>
    </defs>
    </svg> -->
  <div id="container">
    <canvas id="canvas"></canvas>
    <video id="video" autoplay></video>
    <div id="selected"></div>
    <div id="clicked"></div>
  </div>
  <script>
    // setting up scene
    console.log("canvas updating 111")
    var video = window.video = document.querySelector('video');
    var constraints = {
      video: {
        facingMode: "environment",
        video: true,
        audio: false
      }
    };

    //reading camera feed
    function handleSuccess(stream) {
      window.stream = stream;
      video.srcObject = stream;
    }

    function handleError(error) {
      console.log('navigator.getUserMedia error: ', error);
    }
    navigator.mediaDevices.getUserMedia(constraints).
    then(handleSuccess).catch(handleError);

    //set up canvas with video image
    var c = document.getElementById("canvas");
    c.width = document.body.clientWidth;
    c.height = document.body.clientHeight;

    var ctx = c.getContext("2d");
    var video = document.getElementById("video");

    video.addEventListener('play', function() {
      function step() {
        ctx.drawImage(video, 0, 0)
        requestAnimationFrame(step)
      }
      requestAnimationFrame(step);
    })

    function mouseoverColor(evt) {
      var selected = document.getElementById("selected");
      var x = evt.layerX;
      var y = evt.layerY;

      let imageData = ctx.getImageData(x, y, 1, 1);
      ctx.putImageData(imageData, 0, 0);
      var r = imageData.data[0];
      var g = imageData.data[1];
      var b = imageData.data[2];
      var a = imageData.data[3];

      let color = "rgba(" + r + ', ' + g + ', ' + b + ', ' + a + ')';
      // console.log("color for touch with identifier = " + color);
      selected.style.backgroundColor = color;
      selected.textContent = color;

      //touch listener
      canvas.addEventListener('click', function(x) {
        console.log("click", color);
        clicked.style.backgroundColor = color;
        clicked.textContent = color;

        //filter out selected color from canvas
        let newImageData = ctx.getImageData(0, 0, c.width, c.height);
        for (var i = 0; i < newImageData.data.length; i+=4) {
          if (newImageData.data[i] == r && newImageData.data[i+1] == g && newImageData.data[i+2] == b && newImageData.data[i+3] == a) {
            console.log("erasing data")
            newImageData.data[i] = 0;
            newImageData.data[i+1] = 0;
            newImageData.data[i+2] = 0;
            newImageData.data[i+3] = 0;
          }
        };
        ctx.putImageData(newImageData, 0, 0);
      });
    }
    window.addEventListener('mousemove', function(x) {
      // console.log("mousemove", x);
      mouseoverColor(x);
    });

  </script>
</body>

</html>
